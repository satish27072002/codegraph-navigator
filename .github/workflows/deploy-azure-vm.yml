name: Deploy Azure VM

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - "infra/docker-compose.yml"
      - "frontend/**"
      - "backend/services/**"
      - "backend/shared/**"
      - ".github/workflows/deploy-azure-vm.yml"

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      AZURE_APP_DIR: /opt/codegraph-navigator
    steps:
      - uses: actions/checkout@v4

      - name: Check required deploy secrets
        id: precheck
        env:
          AZURE_VM_HOST: ${{ secrets.AZURE_VM_HOST }}
          AZURE_VM_USER: ${{ secrets.AZURE_VM_USER }}
          AZURE_VM_SSH_KEY: ${{ secrets.AZURE_VM_SSH_KEY }}
        run: |
          if [ -z "${AZURE_VM_HOST:-}" ] || [ -z "${AZURE_VM_USER:-}" ] || [ -z "${AZURE_VM_SSH_KEY:-}" ]; then
            echo "ready=false" >> "$GITHUB_OUTPUT"
            echo "Azure deploy secrets are not fully configured. Skipping deployment."
          else
            echo "ready=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Start SSH agent
        if: steps.precheck.outputs.ready == 'true'
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.AZURE_VM_SSH_KEY }}

      - name: Sync repository to VM
        if: steps.precheck.outputs.ready == 'true'
        env:
          VM_HOST: ${{ secrets.AZURE_VM_HOST }}
          VM_USER: ${{ secrets.AZURE_VM_USER }}
        run: |
          rsync -az --delete \
            --exclude '.git' \
            --exclude 'frontend/node_modules' \
            --exclude 'frontend/.next' \
            --exclude 'frontend/dist' \
            --exclude 'data' \
            -e "ssh -o StrictHostKeyChecking=no" \
            ./ "${VM_USER}@${VM_HOST}:${AZURE_APP_DIR}"

      - name: Write .env on VM
        if: steps.precheck.outputs.ready == 'true'
        env:
          VM_HOST: ${{ secrets.AZURE_VM_HOST }}
          VM_USER: ${{ secrets.AZURE_VM_USER }}
          APP_ENV_FILE: ${{ secrets.AZURE_APP_ENV }}
        run: |
          if [ -n "${APP_ENV_FILE:-}" ]; then
            printf '%s\n' "${APP_ENV_FILE}" | ssh -o StrictHostKeyChecking=no "${VM_USER}@${VM_HOST}" "cat > ${AZURE_APP_DIR}/.env"
          else
            echo "AZURE_APP_ENV secret is empty; skipping .env write."
          fi

      - name: Deploy containers
        if: steps.precheck.outputs.ready == 'true'
        env:
          VM_HOST: ${{ secrets.AZURE_VM_HOST }}
          VM_USER: ${{ secrets.AZURE_VM_USER }}
        run: |
          ssh -o StrictHostKeyChecking=no "${VM_USER}@${VM_HOST}" <<'EOFSSH'
            set -euo pipefail
            cd /opt/codegraph-navigator
            docker compose --env-file .env -f infra/docker-compose.yml pull || true
            docker compose --env-file .env -f infra/docker-compose.yml up -d --build --remove-orphans
            docker compose --env-file .env -f infra/docker-compose.yml ps
          EOFSSH

      - name: Deploy skipped
        if: steps.precheck.outputs.ready != 'true'
        run: echo "Skipping Azure deployment because required secrets are missing."
